<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Luna Chat</title>

  <style>
    body {
      font-family: Arial, sans-serif;
      background-image: url("assets/imagens/luna/fundo.jpg");
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;
      color: #fff;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      margin: 0;
    }

    .chat-container {
      width: 360px;
      max-width: 95%;
      background-color: rgba(42, 42, 61, 0.92);
      border-radius: 12px;
      padding: 10px;
      display: flex;
      flex-direction: column;
      height: 540px;
      box-shadow: 0 0 20px rgba(0,0,0,0.6);
    }

    .avatar {
      display: flex;
      justify-content: center;
      margin-bottom: 6px;
    }

    .avatar img {
      width: 90px;
      height: 90px;
      border-radius: 50%;
      border: 3px solid #ffcc66;
      object-fit: cover;
    }

    .chat-window {
      flex: 1;
      overflow-y: auto;
      padding: 8px;
      border-radius: 6px;
      background-color: #1f1f2d;
      margin-bottom: 6px;
    }

    .message {
      margin: 6px 0;
      line-height: 1.4;
    }

    .user { color: #9acdff; }
    .luna { color: #ffcc66; }

    input {
      width: 100%;
      padding: 9px;
      border-radius: 6px;
      border: none;
      outline: none;
      margin-bottom: 6px;
    }

    .buttons {
      display: flex;
      gap: 6px;
    }

    button {
      flex: 1;
      padding: 9px;
      border: none;
      border-radius: 6px;
      background-color: #ffcc66;
      font-weight: bold;
      cursor: pointer;
    }

    button:hover {
      background-color: #e6b24d;
    }

    .mic {
      background-color: #6cf;
    }
  </style>
</head>

<body>

<div class="chat-container">

  <div class="avatar">
    <img src="assets/imagens/luna/logoluna.jpg" alt="Luna">
  </div>

  <div class="chat-window" id="chatWindow"></div>

  <input type="text" id="userInput" placeholder="Escreva ou fale algo...">

  <div class="buttons">
    <button onclick="enviar()">Enviar</button>
    <button class="mic" onclick="ouvir()">ðŸŽ¤</button>
  </div>

</div>

<script>
  const API_URL = "https://luna-ad4s.onrender.com/chat";

  const chatWindow = document.getElementById("chatWindow");
  const userInput = document.getElementById("userInput");

  let vozSelecionada = null;

  function addMessage(text, sender) {
    const div = document.createElement("div");
    div.className = "message " + sender;
    div.textContent = text;
    chatWindow.appendChild(div);
    chatWindow.scrollTop = chatWindow.scrollHeight;
  }

  // ðŸ˜€ Remove emojis (para a fala)
  function removerEmojis(texto) {
    return texto.replace(
      /[\p{Emoji_Presentation}\p{Extended_Pictographic}]/gu,
      ""
    ).trim();
  }

  // ðŸŽ§ Carrega vozes do sistema
  function carregarVozes() {
    const vozes = speechSynthesis.getVoices();

    vozSelecionada = vozes.find(v =>
      v.lang === "pt-BR" &&
      (
        v.name.toLowerCase().includes("fem") ||
        v.name.toLowerCase().includes("female") ||
        v.name.toLowerCase().includes("mulher")
      )
    );

    if (!vozSelecionada) {
      vozSelecionada = vozes.find(v => v.lang === "pt-BR") || vozes[0];
    }
  }

  speechSynthesis.onvoiceschanged = carregarVozes;

  // ðŸ”Š Falar
  function falar(texto) {
    if (!vozSelecionada) carregarVozes();

    const textoLimpo = removerEmojis(texto);

    const fala = new SpeechSynthesisUtterance(textoLimpo);
    fala.voice = vozSelecionada;
    fala.lang = "pt-BR";
    fala.rate = 1;
    fala.pitch = 1.2;

    speechSynthesis.cancel();
    speechSynthesis.speak(fala);
  }

  // ðŸ“¤ Enviar mensagem
  async function enviar() {
    const pergunta = userInput.value.trim();
    if (!pergunta) return;

    addMessage("VocÃª: " + pergunta, "user");
    userInput.value = "";

    try {
      const response = await fetch(API_URL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ message: pergunta })
      });

      const data = await response.json();
      const resposta = data.response || "NÃ£o entendi.";

      addMessage("Luna: " + resposta, "luna");
      falar(resposta);

    } catch (e) {
      addMessage("Luna: Erro de conexÃ£o ðŸ˜¢", "luna");
    }
  }

  // ðŸŽ¤ Microfone
  function ouvir() {
    if (!("webkitSpeechRecognition" in window)) {
      alert("Reconhecimento de voz nÃ£o suportado.");
      return;
    }

    const recognition = new webkitSpeechRecognition();
    recognition.lang = "pt-BR";
    recognition.start();

    recognition.onresult = (event) => {
      const texto = event.results[0][0].transcript;
      userInput.value = texto;
      enviar();
    };
  }

  userInput.addEventListener("keydown", e => {
    if (e.key === "Enter") enviar();
  });
</script>

</body>
</html>
